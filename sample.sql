SELECT to_date(p.reg_time) as reg_date, count(distinct e.player_id) as actives, count(distinct case when e.event_id=1700 and e.player_action_id in (87) then e.player_id end) as start_bundle, count(distinct case when e.event_id=1700 and e.player_action_id in (88) then e.player_id end) as finish_bundle, count(distinct case when e.event_id=2100 and movement_source_type_name='BundlesLoadingReward' then e.player_id end) as bundle_reward, count(distinct case when e.event_id=1900 and e.log_source_id = 'RaidLogRecordQuest' and e.sub_category_id = -1 and e.category_type<>'BattlePass' and e.progress_type_id=5 and e.key_name like '%Summon 1 Magic hero%' then e.player_id end) as Challenge_summon_magic_hero, count(distinct case when e.event_id=1900 and sub_category_type='Daily' and e.key_name like '%Enhance {0} Artifact(s)%' and progress_type_id=5 and e.category_type not in ('Wizard') then e.player_id end) as Quest_make_4_artifacts_upgrade, count(distinct case when e.event_id=1900 and e.sub_category_type <> 'Daily' and e.key_name like '%Turn on notifications%' and progress_type_id=5 then e.player_id end) as Enable_notifications_achivements, count(distinct case when e.event_id=2100 and e.product_id=52 and e.product_count=7500 and e.log_source_id='RaidLogRecordSessionChest' then e.player_id end) as play_time_reward from dwh_kh.dwh_events_global e LEFT JOIN dwh_kh.dim_player p on p.bundle_id=e.bundle_id and e.player_id=p.player_id and p.bundle_id=10 left join dwh.view_country c on c.country_id=p.reg_country_id where e.bundle_id=10 and e.day = 20200201 and p.is_bot=0 and p.is_test_player=0 and c.country_name not in ('China','Russian Federation') and p.reg_network_id in (7,8) and e.event_id in (1300,1700,1900,2100,1500) and datediff(to_date(e.event_time), to_date(p.reg_time))=0 group by 1
